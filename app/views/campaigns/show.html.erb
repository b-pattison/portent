<% if @campaign&.errors&.any? %>
  <div id="error_explanation">
    <h2><%= pluralize(@campaign.errors.count, "error") %> prohibited this campaign from being saved:</h2>
    <ul>
      <% @campaign.errors.each do |error| %>
        <li><%= error.full_message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px;">
  <h1 style="margin: 0;"><%= @campaign.name %></h1>
  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    <%= link_to "Edit", edit_campaign_path(@campaign), class: "btn btn-secondary" %>
    <button type="button" 
            onclick="showDeleteModal()" 
            class="btn btn-danger">
      Delete
    </button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-campaign-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(26, 31, 58, 0.85); backdrop-filter: blur(8px); z-index: 1000; padding: 20px; align-items: center; justify-content: center;">
  <div style="background: linear-gradient(135deg, #2d3561 0%, #6b46c1 100%); padding: clamp(20px, 5vw, 32px); border-radius: 20px; max-width: min(90vw, 500px); width: 100%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 2px rgba(212, 175, 55, 0.4); border: 2px solid rgba(212, 175, 55, 0.6);">
    <h3 style="margin-top: 0; margin-bottom: 16px; font-size: clamp(20px, 4.5vw, 24px); font-weight: 700; color: #d4af37; text-shadow: 0 2px 8px rgba(212, 175, 55, 0.3); text-align: center; font-family: 'Cinzel', serif;">
      Delete Campaign
    </h3>
    <p style="font-size: clamp(14px, 3.5vw, 16px); line-height: 1.6; color: #ffffff; margin-bottom: 24px; text-align: center;">
      Are you sure you want to delete <strong style="color: #a78bfa;"><%= @campaign.name %></strong>?
      <br><br>
      This will <strong style="color: #dc3545;">permanently delete</strong> all encounters, PCs, NPCs, and all associated data.
      <br><br>
      <strong style="color: #dc3545;">This action cannot be undone.</strong>
    </p>
    <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
      <%= button_to "Delete Campaign",
          campaign_path(@campaign),
          method: :delete,
          data: { turbo_method: :delete },
          class: "btn btn-danger",
          style: "flex: 1; min-width: 120px; padding: 14px 20px; font-size: clamp(14px, 3.5vw, 16px); background-color: #dc3545; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; min-height: 48px; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); transition: all 0.2s;",
          onmouseover: "this.style.backgroundColor='#c82333'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(220, 53, 69, 0.4)';",
          onmouseout: "this.style.backgroundColor='#dc3545'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)';" %>
      <button type="button" 
              onclick="hideDeleteModal()" 
              style="flex: 1; min-width: 120px; padding: 14px 20px; font-size: clamp(14px, 3.5vw, 16px); background-color: #423067; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; min-height: 48px; box-shadow: 0 4px 12px rgba(66, 48, 103, 0.3); transition: all 0.2s;"
              onmouseover="this.style.backgroundColor='#29204E'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(66, 48, 103, 0.4)';"
              onmouseout="this.style.backgroundColor='#423067'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(66, 48, 103, 0.3)';">
        Cancel
      </button>
    </div>
  </div>
</div>

<script>
  function showDeleteModal() {
    document.getElementById('delete-campaign-modal').style.display = 'flex';
  }

  function hideDeleteModal() {
    document.getElementById('delete-campaign-modal').style.display = 'none';
  }

  // Close modal when clicking outside
  document.getElementById('delete-campaign-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      hideDeleteModal();
    }
  });
</script>

<div class="card">
  <h2>Encounters</h2>
  <% if @active_encounter %>
    <div style="margin-bottom: 20px;">
      <p style="margin-bottom: 12px; opacity: 0.9;">
        <strong style="color: var(--gold);">Active Encounter</strong>
        <br>
        <span style="font-size: clamp(12px, 3vw, 14px); opacity: 0.7;">
          Started <%= @active_encounter.created_at.strftime("%B %d, %Y at %I:%M %p") %>
        </span>
      </p>
      <%= link_to "View Active Encounter →", campaign_encounter_path(@campaign, @active_encounter), class: "btn btn-primary", style: "width: 100%; max-width: 300px;" %>
    </div>
  <% else %>
    <%= button_to "Start New Encounter",
                  start_encounter_campaign_path(@campaign),
                  method: :post,
                  class: "btn btn-primary",
                  style: "width: 100%; max-width: 300px;" %>
  <% end %>

  <% if @past_encounters.any? %>
    <h3 style="margin-top: 32px; margin-bottom: 16px;">Past Encounters</h3>
    <div style="display: flex; flex-direction: column; gap: 12px;">
      <% @past_encounters.each do |encounter| %>
        <div style="padding: 12px; background: rgba(26, 31, 64, 0.4); border-radius: 8px; border: 1px solid var(--light-purple)30;">
          <%= link_to "Encounter from #{encounter.created_at.strftime("%B %d, %Y at %I:%M %p")}", 
                      campaign_encounter_path(@campaign, encounter),
                      style: "color: var(--lavender); text-decoration: none;" %>
        </div>
      <% end %>
    </div>
    <% if @past_encounters_count > 5 %>
      <div style="margin-top: 16px;">
        <%= link_to "View All Past Encounters (#{@past_encounters_count}) →", 
                    past_encounters_campaign_path(@campaign), 
                    class: "btn btn-secondary",
                    style: "width: 100%; max-width: 300px;" %>
      </div>
    <% end %>
  <% end %>
</div>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
    <h2 style="margin: 0;">Player Characters</h2>
    <%= link_to "Add PC", new_campaign_character_path(@campaign, pc: true), class: "btn btn-primary" %>
  </div>
  
  <% pcs = @campaign.characters.pcs.permanent %>
  <% if pcs.empty? %>
    <p style="opacity: 0.7; text-align: center; padding: 20px;">No PCs yet. Add your first player character!</p>
  <% else %>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr)); gap: 16px;">
      <% pcs.each do |character| %>
        <div style="padding: 16px; background: rgba(26, 31, 64, 0.4); border-radius: 12px; border: 1px solid var(--light-purple)30;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <% if character.avatar.attached? %>
              <%= image_tag character.avatar, alt: character.name, class: "avatar" %>
            <% else %>
              <%= image_tag "default_avatar.png", alt: character.name, class: "avatar" %>
            <% end %>
            <div>
              <div style="font-weight: 600; font-size: clamp(16px, 4vw, 18px); color: var(--white);">
                <%= character.name %>
              </div>
              <div style="font-size: clamp(12px, 3vw, 14px); opacity: 0.7; color: var(--lavender);">
                Init Mod: <%= character.initiative_mod >= 0 ? "+" : "" %><%= character.initiative_mod %>
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <%= link_to "Edit", edit_campaign_character_path(@campaign, character), class: "btn btn-secondary", style: "flex: 1; min-width: 80px; padding: 8px 12px; font-size: clamp(12px, 3vw, 14px);" %>
            <%= link_to "Delete",
                campaign_character_path(@campaign, character),
                data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this character?" },
                class: "btn btn-danger",
                style: "flex: 1; min-width: 80px; padding: 8px 12px; font-size: clamp(12px, 3vw, 14px);" %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
    <h2 style="margin: 0;">NPCs</h2>
    <%= link_to "Add NPC", new_campaign_character_path(@campaign, pc: false), class: "btn btn-primary" %>
  </div>
  <% npcs = @campaign.characters.npcs.permanent %>
  <% if npcs.empty? %>
    <p style="opacity: 0.7; text-align: center; padding: 20px;">No NPCs yet.</p>
  <% else %>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr)); gap: 16px;">
      <% npcs.each do |character| %>
        <div style="padding: 16px; background: rgba(26, 31, 64, 0.4); border-radius: 12px; border: 1px solid var(--light-purple)30;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <% if character.avatar.attached? %>
              <%= image_tag character.avatar, alt: character.name, class: "avatar" %>
            <% else %>
              <%= image_tag "default_avatar.png", alt: character.name, class: "avatar" %>
            <% end %>
            <div>
              <div style="font-weight: 600; font-size: clamp(16px, 4vw, 18px); color: var(--white);">
                <%= character.name %>
              </div>
              <div style="font-size: clamp(12px, 3vw, 14px); opacity: 0.7; color: var(--lavender);">
                Init Mod: <%= character.initiative_mod >= 0 ? "+" : "" %><%= character.initiative_mod %>
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <%= link_to "Edit", edit_campaign_character_path(@campaign, character), class: "btn btn-secondary", style: "flex: 1; min-width: 80px; padding: 8px 12px; font-size: clamp(12px, 3vw, 14px);" %>
            <%= link_to "Delete",
                campaign_character_path(@campaign, character),
                data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this character?" },
                class: "btn btn-danger",
                style: "flex: 1; min-width: 80px; padding: 8px 12px; font-size: clamp(12px, 3vw, 14px);" %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>


