<h1>Encounter <%= @encounter.status == "active" ? "Running" : "Setup" %></h1>

<div class="card" style="margin-bottom: 24px;">
  <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
    <div>
      <span style="opacity: 0.7; font-size: clamp(14px, 3.5vw, 16px); font-family: 'Cinzel', serif; font-weight: 500; letter-spacing: 0.04em;">Status:</span>
      <strong style="color: var(--gold); font-size: clamp(16px, 4vw, 18px); margin-left: 8px; text-transform: capitalize; font-family: 'Cinzel', serif; font-weight: 500; letter-spacing: 0.04em;">
        <%= @encounter.status %>
      </strong>
    </div>
    <% if @encounter.status == "active" && @encounter.active_participant.present? %>
      <span style="color: var(--lavender); opacity: 0.7;">•</span>
      <div>
        <span style="opacity: 0.7; font-size: clamp(14px, 3.5vw, 16px); font-family: 'Cinzel', serif; font-weight: 500; letter-spacing: 0.04em;">Up next:</span>
        <strong style="color: var(--lavender); font-size: clamp(16px, 4vw, 18px); margin-left: 8px; font-family: 'Cinzel', serif; font-weight: 500; letter-spacing: 0.04em;">
          <%= @encounter.active_participant.character.name %>
        </strong>
      </div>
    <% end %>
  </div>
</div>

<% ended = (@encounter.status == "ended") %>

<% if @encounter.status == "active" %>
  <div id="combat-console-wrapper">
    <div
      id="combat-console-root"
      data-campaign-id="<%= @campaign.id %>"
      data-encounter-id="<%= @encounter.id %>"
      data-csrf-token="<%= form_authenticity_token %>"
    >
      <p>Loading combat console…</p>
    </div>
  </div>

  <div id="add-combatant-form-wrapper" style="display: none;">
    <div class="card">
      <h2>Add NPC/Enemy</h2>
      <p style="margin-bottom: 1rem; opacity: 0.7; font-size: clamp(14px, 3.5vw, 16px);">
        Combatant will be added at the end of the current round.
      </p>
    <%= form_with url: add_combatant_campaign_encounter_path(@campaign, @encounter), 
                  method: :post, 
                  id: "add-combatant-form-active",
                  data: { turbo: false },
                  multipart: true,
                  onsubmit: "return handleAddCombatantSubmit(event)" do %>
      <% if @available_npcs.any? %>
        <div>
          <%= label_tag "add_type_active", "Add Type" %>
          <%= radio_button_tag "add_type_active", "existing", false, id: "add_type_existing_active", onchange: "toggleAddCombatantType('active')" %>
          <%= label_tag "add_type_existing_active", "Select from Saved NPCs", style: "margin-left: 8px; cursor: pointer;" %>
          <br>
          <%= radio_button_tag "add_type_active", "new", true, id: "add_type_new_active", onchange: "toggleAddCombatantType('active')", style: "margin-top: 8px;" %>
          <%= label_tag "add_type_new_active", "Create New NPC", style: "margin-left: 8px; cursor: pointer;" %>
        </div>

        <div id="select_npc_active" style="display: none; margin-top: 1rem;">
          <%= label_tag "character_id_active", "Select NPC" %>
          <%= select_tag "character_id", 
                         options_from_collection_for_select(@available_npcs, :id, :name),
                         { prompt: "Choose an NPC...", id: "character_id_active", style: "width: 100%;", onchange: "updateInitiativeFromNPC(this)" } %>
        </div>
      <% end %>

      <div id="new_npc_active" <%= 'style="display: none;"'.html_safe if @available_npcs.any? %>>
        <%= label_tag "character[name]", "Name" %>
        <%= text_field_tag "character[name]", nil, placeholder: "Enter NPC name", required: !@available_npcs.any?, id: "character_name_active" %>

        <%= label_tag "character[initiative_mod]", "Initiative mod" %>
        <%= number_field_tag "character[initiative_mod]", 0, required: !@available_npcs.any?, id: "character_initiative_mod_active" %>

        <div style="margin-top: 1rem;">
          <%= label_tag "character[avatar]", "Avatar (optional)" %>
          <%= file_field_tag "character[avatar]", 
                            accept: "image/png,image/jpeg,image/jpg",
                            style: "margin-top: 0.25rem;" %>
          <small style="display: block; opacity: 0.7; margin-top: 0.25rem;">
            PNG or JPG, max 2MB. If not provided, default avatar will be used.
          </small>
        </div>
      </div>

      <div style="margin-top: 1rem;">
        <%= label_tag "character[initiative_roll]", "Initiative roll" %>
        <%= number_field_tag "character[initiative_roll]", nil, min: 1, max: 30, step: 1, required: true %>
      </div>

      <div style="margin-top: 1rem;">
        <%= submit_tag "Add Combatant", class: "btn btn-primary" %>
        <button type="button" class="btn btn-secondary" onclick="cancelAddCombatant()" style="margin-left: 0.5rem;">
          Cancel
        </button>
      </div>
    <% end %>
    </div>
  </div>

  <div id="add-effect-form-wrapper" style="display: none;">
    <div class="card">
      <h2>Add Effect</h2>
    <%= form_with url: effects_campaign_encounter_path(@campaign, @encounter),
                  method: :post,
                  id: "add-effect-form",
                  data: { turbo: false } do %>
      <%= label_tag "effect[name]", "Effect Name" %>
      <%= text_field_tag "effect[name]", nil, required: true %>

      <%= label_tag "effect[note]", "Note (optional)" %>
      <%= text_area_tag "effect[note]", nil, rows: 2 %>

      <div style="margin-top: 1rem;">
        <strong>Duration:</strong>
        <div style="margin-top: 0.5rem;">
          <%= radio_button_tag "duration_type", "end_of_round", true, id: "duration_end_of_round", onchange: "updateDurationFields()" %>
          <%= label_tag "duration_end_of_round", "End of round" %>
        </div>
        <div>
          <%= radio_button_tag "duration_type", "end_of_turn", false, id: "duration_end_of_turn", onchange: "updateDurationFields()" %>
          <%= label_tag "duration_end_of_turn" do %>
            End of character's next turn
            <span id="end_of_turn_info" style="opacity: 0.7; font-weight: normal;">
              <% if @encounter.active_participant.present? %>
                (<%= @encounter.active_participant.character.name %>'s turn in round <%= @encounter.round_number + 1 %>)
              <% else %>
                (Current active participant's next turn)
              <% end %>
            </span>
          <% end %>
        </div>
        <div>
          <%= radio_button_tag "duration_type", "time", false, id: "duration_time", onchange: "updateDurationFields()" %>
          <%= label_tag "duration_time", "Time" %>
          <div id="time_duration_wrapper" style="display: none; margin-left: 2rem; margin-top: 0.5rem;">
            <%= number_field_tag "time_amount", nil, min: 1, style: "width: 80px;" %>
            <%= select_tag "time_unit", options_for_select([["Seconds", "seconds"], ["Minutes", "minutes"]], "seconds") %>
          </div>
        </div>
      </div>

      <div style="margin-top: 1rem;">
        <strong>Who it affects:</strong>
        <div id="targets_wrapper" style="margin-top: 0.5rem;">
          <% @encounter.encounter_participants.where.not(state: ["removed", "dead"]).includes(:character).each do |participant| %>
            <div style="margin: 0.5rem 0;">
              <%= check_box_tag "target_ids[]", participant.id, false, 
                                id: "target_#{participant.id}",
                                onchange: "updateTargetTiming(#{participant.id})" %>
              <%= label_tag "target_#{participant.id}", participant.character.name %>
              <div id="target_timing_<%= participant.id %>" style="display: none; margin-left: 2rem; margin-top: 0.25rem;">
                <%= select_tag "target_timings[#{participant.id}]",
                              options_for_select([["None", "none"], ["Start of turn", "start_of_turn"], ["End of turn", "end_of_turn"]], "start_of_turn"),
                              onchange: "updateSaveTypeVisibility()" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <div style="margin-top: 1rem;" id="save_ability_wrapper">
        <%= label_tag "effect[save_ability]", "Save Type (optional)" %>
        <%= select_tag "effect[save_ability]",
                      options_for_select([
                        ["None", ""],
                        ["Wisdom", "wis"],
                        ["Intelligence", "int"],
                        ["Strength", "str"],
                        ["Constitution", "con"],
                        ["Dexterity", "dex"]
                      ], ""),
                      { id: "save_ability_select" } %>
      </div>

      <div style="margin-top: 1rem;">
        <%= label_tag "effect[hp_delta]", "HP Effect" %>
        <%= number_field_tag "effect[hp_delta]", 0, required: true %>
        <small style="display: block; opacity: 0.7; margin-top: 0.25rem;">
          Negative = damage, positive = healing
        </small>
      </div>

      <div style="margin-top: 1rem;">
        <%= submit_tag "Add Effect", class: "btn btn-primary" %>
        <button type="button" class="btn btn-secondary" onclick="cancelAddEffect()" style="margin-left: 0.5rem;">
          Cancel
        </button>
      </div>
    <% end %>
    </div>
  </div>

  <%= vite_javascript_tag "entrypoints/encounters/run.jsx" %>
<% else %>
  <% if ended %>
    <div class="alert alert-info" style="margin-bottom: clamp(16px, 4vw, 24px);">
      This encounter has ended. Setup actions are locked.
    </div>
  <% end %>

<%= form_with url: update_rolls_campaign_encounter_path(@campaign, @encounter),
              method: :patch,
              local: true do %>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
      <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Roll</th>
          <th>Mod</th>
          <th>Total</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody id="active_combatants">
        <% @participants.select { |p| p.state != "removed" }.each do |p| %>
          <% character = p.character %>
          <tr>
            <td><%= character.name %></td>
            <td><%= character.pc? ? "Player Character" : "NPC" %></td>

            <td>
              <%= number_field_tag "participants[#{p.id}][initiative_roll]",
                                   p.initiative_roll,
                                   min: 1, max: 30, step: 1,
                                   disabled: ended %>
            </td>

            <td><%= p.initiative_mod %></td>
            <td><%= p.initiative_total || "—" %></td>

            <td>
              <% unless ended %>
                <% if p.state == "alive" %>
                  <button type="button"
                          class="btn btn-danger"
                          onclick="markDead(<%= p.id %>)"
                          data-participant-id="<%= p.id %>">
                    Mark Dead
                  </button>
                <% end %>

                <%= button_to "Remove",
                              remove_campaign_encounter_encounter_participant_path(@campaign, @encounter, p),
                              method: :patch,
                              data: { turbo_confirm: "Remove this combatant from the encounter?" },
                              class: "btn btn-danger",
                              form: { style: "display: inline; margin: 0; padding: 0; border: none; background: none;" } %>
              <% else %>
                <span style="opacity: 0.6;">Locked</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    </div>

    <% unless ended %>
      <div style="margin-top: clamp(20px, 5vw, 32px);">
        <%= submit_tag(@missing_rolls ? "Save initiative rolls" : "Save & Activate",
                       class: "btn btn-primary",
                       style: "width: 100%; max-width: 300px;") %>
      </div>
    <% end %>
  <% end %>
<% end %>

<hr style="margin: clamp(32px, 8vw, 48px) 0;">

<% unless ended %>
  <% if @encounter.status != "active" %>
    <% if @available_pcs.any? %>
      <div class="card">
        <h2>Add Saved PCs</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr)); gap: 16px;">
          <% @available_pcs.each do |pc| %>
            <div style="padding: 16px; background: rgba(26, 31, 64, 0.4); border-radius: 12px; border: 1px solid var(--antique-gold)30;">
              <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <% if pc.avatar.attached? %>
                  <%= image_tag pc.avatar, alt: pc.name, class: "avatar" %>
                <% else %>
                  <%= image_tag "default_avatar.png", alt: pc.name, class: "avatar" %>
                <% end %>
                <div style="flex: 1; margin-left: 12px;">
                  <div style="font-weight: 600; font-size: clamp(16px, 4vw, 18px); color: var(--moonlight-ivory); font-family: 'Cinzel', serif; font-weight: 500; letter-spacing: 0.04em;">
                    <%= pc.name %>
                  </div>
                  <div style="font-size: clamp(12px, 3vw, 14px); opacity: 0.7; color: var(--amethyst-dusk);">
                    Init Mod: <%= pc.initiative_mod >= 0 ? "+" : "" %><%= pc.initiative_mod %>
                  </div>
                </div>
              </div>
              <%= button_to "Add to Initiative",
                            add_combatant_campaign_encounter_path(@campaign, @encounter),
                            method: :post,
                            params: { character_id: pc.id },
                            class: "btn btn-secondary",
                            style: "width: 100%; padding: 8px 12px; font-size: clamp(12px, 3vw, 14px);" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if @available_npcs.any? %>
      <div class="card" <%= 'style="margin-top: 20px;"'.html_safe if @available_pcs.any? %>>
        <h2>Add Saved NPCs</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr)); gap: 16px;">
          <% @available_npcs.each do |npc| %>
            <div style="padding: 16px; background: rgba(26, 31, 64, 0.4); border-radius: 12px; border: 1px solid var(--antique-gold)30;">
              <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <% if npc.avatar.attached? %>
                  <%= image_tag npc.avatar, alt: npc.name, class: "avatar" %>
                <% else %>
                  <%= image_tag "default_avatar.png", alt: npc.name, class: "avatar" %>
                <% end %>
                <div style="flex: 1; margin-left: 12px;">
                  <div style="font-weight: 600; font-size: clamp(16px, 4vw, 18px); color: var(--moonlight-ivory); font-family: 'Cinzel', serif; font-weight: 500; letter-spacing: 0.04em;">
                    <%= npc.name %>
                  </div>
                  <div style="font-size: clamp(12px, 3vw, 14px); opacity: 0.7; color: var(--amethyst-dusk);">
                    Init Mod: <%= npc.initiative_mod >= 0 ? "+" : "" %><%= npc.initiative_mod %>
                  </div>
                </div>
              </div>
              <%= button_to "Add to Initiative",
                            add_combatant_campaign_encounter_path(@campaign, @encounter),
                            method: :post,
                            params: { character_id: npc.id },
                            class: "btn btn-secondary",
                            style: "width: 100%; padding: 8px 12px; font-size: clamp(12px, 3vw, 14px);" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="card" style="margin-top: 20px;">
      <h2>Create New NPC/Enemy</h2>
      <%= form_with url: add_combatant_campaign_encounter_path(@campaign, @encounter), method: :post, multipart: true do %>
        <div>
          <%= label_tag "character[name]", "Name" %>
          <%= text_field_tag "character[name]", nil, placeholder: "Enter NPC name", required: true %>
        </div>

        <div>
          <%= label_tag "character[initiative_mod]", "Initiative Modifier" %>
          <%= number_field_tag "character[initiative_mod]", 0, required: true %>
        </div>

        <div>
          <%= label_tag "character[avatar]", "Avatar (optional)" %>
          <%= file_field_tag "character[avatar]", accept: "image/png,image/jpeg,image/jpg" %>
          <small>PNG or JPG, max 2MB.</small>
        </div>

        <%= submit_tag "Add", class: "btn btn-secondary" %>
      <% end %>
    </div>
  <% else %>
    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: clamp(20px, 5vw, 32px);">
      <button type="button" 
              class="btn btn-secondary" 
              onclick="showAddCombatantForm()"
              id="show-add-combatant-btn"
              style="flex: 1; min-width: 150px; border: 1px solid rgba(214, 194, 122, 0.6) !important;">
        Add NPC/Enemy
      </button>
      <button type="button" 
              class="btn btn-secondary" 
              onclick="showAddEffectForm()"
              id="show-add-effect-btn"
              style="flex: 1; min-width: 150px; border: 1px solid rgba(214, 194, 122, 0.6) !important;">
        Add Effect
      </button>
    </div>
  <% end %>

  <div style="margin-top: clamp(20px, 5vw, 32px);">
    <%= button_to "End Encounter",
                  end_encounter_campaign_encounter_path(@campaign, @encounter),
                  method: :patch,
                  data: { turbo_confirm: "End this encounter?", turbo_frame: "_top" },
                  class: "btn btn-danger",
                  style: "width: 100%; max-width: 300px;" %>
  </div>
<% else %>
  <div class="alert alert-info" style="margin-top: clamp(20px, 5vw, 32px);">
    Encounter ended — actions are disabled.
  </div>
<% end %>

<script>
  function getCSRFToken() {
    const el = document.querySelector('meta[name="csrf-token"]');
    return el ? el.content : '';
  }

  function advanceTurn() {
    const url = '<%= advance_turn_campaign_encounter_path(@campaign, @encounter) %>';
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken(),
        'Accept': 'application/json'
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => window.location.reload())
    .catch(error => console.error('Error advancing turn:', error));
  }

  function markDead(participantId) {
    const urlTemplate = '<%= campaign_encounter_encounter_participant_path(@campaign, @encounter, "PARTICIPANT_ID") %>';
    const url = urlTemplate.replace("PARTICIPANT_ID", participantId);

    fetch(url, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken(),
        'Accept': 'application/json'
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        encounter_participant: { state: 'dead' }
      })
    })
    .then(response => response.json())
    .then(data => window.location.reload())
    .catch(error => console.error('Error marking dead:', error));
  }

  <% if @encounter.status == "active" %>
    let savedEncounterState = null;

    function showAddCombatantForm() {
      savedEncounterState = {
        activeParticipantId: <%= @encounter.active_participant_id || 'null' %>,
        roundNumber: <%= @encounter.round_number || 1 %>,
        status: '<%= @encounter.status %>'
      };
      console.log('Saved encounter state:', savedEncounterState);

      const consoleWrapper = document.getElementById('combat-console-wrapper');
      const formWrapper = document.getElementById('add-combatant-form-wrapper');
      const showBtn = document.getElementById('show-add-combatant-btn');

      if (consoleWrapper) consoleWrapper.style.display = 'none';
      if (formWrapper) formWrapper.style.display = 'block';
      if (showBtn) showBtn.style.display = 'none';
    }

    function cancelAddCombatant() {
      const consoleWrapper = document.getElementById('combat-console-wrapper');
      const formWrapper = document.getElementById('add-combatant-form-wrapper');
      const showBtn = document.getElementById('show-add-combatant-btn');

      if (consoleWrapper) consoleWrapper.style.display = 'block';
      if (formWrapper) formWrapper.style.display = 'none';
      if (showBtn) showBtn.style.display = 'block';

      savedEncounterState = null;
    }

  function handleAddCombatantSubmit(event) {
    return true;
  }

  function showAddEffectForm() {
    const consoleWrapper = document.getElementById('combat-console-wrapper');
    const formWrapper = document.getElementById('add-effect-form-wrapper');
    const showBtn = document.getElementById('show-add-effect-btn');
    const form = document.getElementById('add-effect-form');

    if (consoleWrapper) consoleWrapper.style.display = 'none';
    if (formWrapper) formWrapper.style.display = 'block';
    if (showBtn) showBtn.style.display = 'none';
    
    if (form) {
      form.addEventListener('submit', handleAddEffectSubmit, { once: false });
    }

    updateEndOfTurnInfo();
  }

  function updateEndOfTurnInfo() {
    const stateUrl = '<%= state_campaign_encounter_path(@campaign, @encounter) %>';
    const infoSpan = document.getElementById('end_of_turn_info');
    
    if (!infoSpan) return;

    fetch(stateUrl, {
      headers: { Accept: 'application/json' },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      const encounter = data.encounter;
      const participants = data.participants || [];
      
      if (encounter && encounter.active_participant_id) {
        const activeParticipant = participants.find(p => p.id === encounter.active_participant_id);
        if (activeParticipant) {
          const nextRound = encounter.round + 1;
          infoSpan.textContent = `(${activeParticipant.name}'s turn in round ${nextRound})`;
        } else {
          infoSpan.textContent = '(Current active participant\'s next turn)';
        }
      } else {
        infoSpan.textContent = '(Current active participant\'s next turn)';
      }
    })
    .catch(error => {
      console.error('Error fetching encounter state:', error);
    });
  }

  function cancelAddEffect() {
    const consoleWrapper = document.getElementById('combat-console-wrapper');
    const formWrapper = document.getElementById('add-effect-form-wrapper');
    const showBtn = document.getElementById('show-add-effect-btn');

    if (consoleWrapper) consoleWrapper.style.display = 'block';
    if (formWrapper) formWrapper.style.display = 'none';
    if (showBtn) showBtn.style.display = 'block';
  }

  function updateDurationFields() {
    const time = document.getElementById('duration_time').checked;
    document.getElementById('time_duration_wrapper').style.display = time ? 'block' : 'none';
  }

  const availableNPCs = <%= @available_npcs.map { |npc| { id: npc.id, name: npc.name, initiative_mod: npc.initiative_mod } }.to_json.html_safe %>;

  function toggleAddCombatantType(mode) {
    const isActive = mode === 'active';
    const existingRadio = document.getElementById(isActive ? 'add_type_existing_active' : 'add_type_existing');
    const newRadio = document.getElementById(isActive ? 'add_type_new_active' : 'add_type_new');
    const selectDiv = document.getElementById(isActive ? 'select_npc_active' : 'select_npc_setup');
    const newDiv = document.getElementById(isActive ? 'new_npc_active' : 'new_npc_setup');

    if (!existingRadio || !newRadio || !selectDiv || !newDiv) return;

    if (existingRadio.checked) {
      selectDiv.style.display = 'block';
      newDiv.style.display = 'none';
      
      const nameField = document.getElementById(isActive ? 'character_name_active' : 'character_name_setup');
      const modField = document.getElementById(isActive ? 'character_initiative_mod_active' : 'character_initiative_mod_setup');
      if (nameField) nameField.removeAttribute('required');
      if (modField) modField.removeAttribute('required');
    } else {
      selectDiv.style.display = 'none';
      newDiv.style.display = 'block';
      
      const nameField = document.getElementById(isActive ? 'character_name_active' : 'character_name_setup');
      const modField = document.getElementById(isActive ? 'character_initiative_mod_active' : 'character_initiative_mod_setup');
      if (nameField) nameField.setAttribute('required', 'required');
      if (modField) modField.setAttribute('required', 'required');
    }
  }

  function updateInitiativeFromNPC(selectElement) {
    if (!selectElement || !selectElement.value) return;
    
    const npcId = parseInt(selectElement.value);
    const npc = availableNPCs.find(n => n.id === npcId);
    
    if (npc) {
      const modField = document.getElementById('character_initiative_mod_active');
      if (modField) {
        modField.value = npc.initiative_mod;
      }
    }
  }

  function updateTargetTiming(participantId) {
    const checkbox = document.getElementById('target_' + participantId);
    const timingDiv = document.getElementById('target_timing_' + participantId);
    if (timingDiv) {
      timingDiv.style.display = checkbox.checked ? 'block' : 'none';
      if (checkbox.checked) {
        updateSaveTypeVisibility();
      }
    }
  }

  function updateSaveTypeVisibility() {
    const saveTypeWrapper = document.getElementById('save_ability_wrapper');
    
    if (!saveTypeWrapper) return;
    
    const allTimingSelects = document.querySelectorAll('[id^="target_timing_"]');
    let hasCheckedTarget = false;
    let allSelectedNone = true;
    
    allTimingSelects.forEach(select => {
      const checkboxId = select.id.replace('target_timing_', 'target_');
      const checkbox = document.getElementById(checkboxId);
        if (checkbox && checkbox.checked) {
          hasCheckedTarget = true;
          if (select.value !== 'no_trigger') {
            allSelectedNone = false;
          }
        }
    });
    
        if (hasCheckedTarget && allSelectedNone) {
      saveTypeWrapper.style.display = 'none';
      const saveTypeSelect = document.getElementById('save_ability_select');
      if (saveTypeSelect) saveTypeSelect.value = '';
    } else {
      saveTypeWrapper.style.display = 'block';
    }
  }

  function handleAddEffectSubmit(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const form = event.target;
    const formData = new FormData(form);
    const url = form.action;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': getCSRFToken(),
        'Accept': 'application/json'
      },
      credentials: 'same-origin',
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.errors ? data.errors.join(', ') : 'Failed to add effect');
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        cancelAddEffect();
        window.location.reload();
      } else {
        alert('Error: ' + (data.errors ? data.errors.join(', ') : 'Failed to add effect'));
      }
    })
    .catch(error => {
      console.error('Error adding effect:', error);
      alert('Error adding effect: ' + error.message);
    });

    return false;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('add-effect-form');
      if (form) {
        form.addEventListener('submit', handleAddEffectSubmit);
      }
    });
  } else {
    const form = document.getElementById('add-effect-form');
    if (form) {
      form.addEventListener('submit', handleAddEffectSubmit);
    }
  }
<% end %>
</script>
